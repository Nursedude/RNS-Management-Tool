name: Lint and Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Bash syntax check (rns_management_tool.sh)
        run: bash -n rns_management_tool.sh

      - name: Bash syntax check (reticulum_updater.sh)
        run: bash -n reticulum_updater.sh

      - name: Bash syntax check (lib/ modules)
        run: |
          for module in lib/*.sh; do
            echo "Checking $module..."
            bash -n "$module"
          done

      - name: ShellCheck rns_management_tool.sh
        run: shellcheck -x -S warning rns_management_tool.sh

      - name: ShellCheck reticulum_updater.sh
        run: shellcheck -x -S warning reticulum_updater.sh

      - name: ShellCheck lib/ modules
        run: |
          for module in lib/*.sh; do
            echo "Checking $module..."
            shellcheck -x -S warning "$module"
          done

  check-mode:
    name: Dry-Run Check Mode
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run --check mode
        run: bash rns_management_tool.sh --check

  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Make smoke test executable
        run: chmod +x tests/smoke_test.sh

      - name: Run smoke tests
        run: ./tests/smoke_test.sh --verbose

  bats:
    name: Bats Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          sudo apt-get update
          sudo apt-get install -y bats shellcheck

      - name: Run bats test suite
        run: bats tests/rns_management_tool.bats

      - name: Run hardware validation tests
        run: bats tests/hardware_validation.bats

      - name: Run integration tests
        run: bats tests/integration_tests.bats

  powershell:
    name: PowerShell Syntax
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse main script (syntax check)
        shell: pwsh
        run: |
          $errors = $null
          [System.Management.Automation.Language.Parser]::ParseFile(
            "$PWD/rns_management_tool.ps1",
            [ref]$null,
            [ref]$errors
          )
          if ($errors.Count -gt 0) {
            $errors | ForEach-Object { Write-Error $_.Message }
            exit 1
          }
          Write-Host "PowerShell main script syntax check passed"

      - name: Parse pwsh/ modules (syntax check)
        shell: pwsh
        run: |
          $allErrors = @()
          Get-ChildItem -Path pwsh/*.ps1 | ForEach-Object {
            $errors = $null
            [System.Management.Automation.Language.Parser]::ParseFile(
              $_.FullName,
              [ref]$null,
              [ref]$errors
            )
            if ($errors.Count -gt 0) {
              Write-Host "FAIL: $($_.Name)" -ForegroundColor Red
              $errors | ForEach-Object { Write-Error $_.Message }
              $allErrors += $errors
            } else {
              Write-Host "OK: $($_.Name)"
            }
          }
          if ($allErrors.Count -gt 0) { exit 1 }
          Write-Host "All PowerShell modules passed syntax check"

      - name: PSScriptAnalyzer lint
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          $results = Invoke-ScriptAnalyzer -Path rns_management_tool.ps1 -Settings .PSScriptAnalyzerSettings.psd1 -Severity Warning,Error
          if ($results) {
            $results | Format-Table -AutoSize
            $errorCount = ($results | Where-Object Severity -eq 'Error').Count
            if ($errorCount -gt 0) {
              Write-Error "$errorCount error(s) found by PSScriptAnalyzer"
              exit 1
            }
            Write-Warning "$($results.Count) warning(s) found by PSScriptAnalyzer"
          } else {
            Write-Host "PSScriptAnalyzer: no issues found"
          }

  pester:
    name: Pester Tests
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Pester tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "tests/*.tests.ps1"
          $config.Output.Verbosity = "Detailed"
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputFormat = "NUnitXml"
          $config.TestResult.OutputPath = "tests/pester-results.xml"
          Invoke-Pester -Configuration $config
